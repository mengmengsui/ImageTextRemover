<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>å›¾ç‰‡å»æ–‡å­—å·¥å…·</title>
    <style>
        /* æ ·å¼éƒ¨åˆ†ä¸ä¹‹å‰ä¸€è‡´ï¼Œæœªä¿®æ”¹ */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Inter', sans-serif;
            max-width: 800px;
            margin: 2rem auto;
            padding: 0 1rem;
            background: #f5f7fa;
        }
        .main-container {
            background: white;
            padding: 2rem;
            border-radius: 12px;
            box-shadow: 0 4px 24px rgba(0,0,0,0.08);
        }
        .app-title {
            color: #1a202c;
            font-size: 1.5rem;
            margin-bottom: 1.5rem;
            font-weight: 600;
        }
        .controls {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            margin-bottom: 2rem;
        }
        .button-row {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
        }
        .folder-path {
            padding: 0.75rem 1rem;
            background: #f7fafc;
            border-radius: 8px;
            font-size: 0.85rem;
            color: #4a5568;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .folder-path::before {
            content: 'ğŸ“ æ‰€é€‰æ–‡ä»¶å¤¹ï¼š';
            margin-right: 0.5rem;
            color: #718096;
        }
        .select-btn {
            background: #3182ce;
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: background 0.2s;
        }
        .select-btn:hover { background: #2b6cb0; }
        .reset-btn {
            background: #e53e3e;
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: background 0.2s;
        }
        .reset-btn:hover { background: #c53030; }
        .stats-row {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
        }
        .stats-card {
            padding: 0.75rem 1rem;
            border-radius: 8px;
            background: #edf2f7;
            font-size: 0.9rem;
            min-width: 100px;
        }
        .stats-card span {
            font-weight: 600;
            margin-left: 0.25rem;
        }
        .stats-pending span { color: #4a5568; }
        .stats-success span { color: #38a169; }
        .stats-error span { color: #e53e3e; }
        .progress-item {
            padding: 1rem;
            margin-bottom: 0.75rem;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        .progress-item span:first-child {
            flex: 1;
            margin-right: 1rem;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .progress-processing { background: #fffaf0; border-left: 4px solid #d69e2e; }
        .progress-success { background: #f0fff4; border-left: 4px solid #38a169; }
        .progress-error { background: #fff5f5; border-left: 4px solid #e53e3e; }
    </style>
</head>
<body>
    <div class="main-container">
        <h1 class="app-title">å›¾ç‰‡å»æ–‡å­—å¤„ç†å·¥å…·</h1>

        <div class="controls">
            <div class="button-row">
                <button class="select-btn" id="selectFolder">é€‰æ‹©å¾…å¤„ç†æ–‡ä»¶å¤¹</button>
                <button class="reset-btn" id="resetBtn">é‡ç½®</button>
            </div>

            <div class="folder-path" id="folderPathDisplay">æœªé€‰æ‹©æ–‡ä»¶å¤¹</div>

            <div class="stats-row">
                <div class="stats-card stats-pending">å¾…å¤„ç†ï¼š<span id="statsPending">0</span>å¼ </div>
                <div class="stats-card stats-success">å·²æˆåŠŸï¼š<span id="statsSuccess">0</span>å¼ </div>
                <div class="stats-card stats-error">å¤„ç†å¤±è´¥ï¼š<span id="statsError">0</span>å¼ </div>
            </div>
        </div>

        <div id="progressContainer"></div>
    </div>

    <script>
        let taskId = null;
        let totalImages = 0;
        let progressInterval = null;
        const folderPathDisplay = document.getElementById('folderPathDisplay');

        // åˆå§‹åŒ–æ‰€æœ‰çŠ¶æ€ï¼ˆæ ¸å¿ƒé‡ç½®å‡½æ•°ï¼‰
        function resetAllStates() {
            taskId = null;
            totalImages = 0;
            clearInterval(progressInterval);  // åœæ­¢è½®è¯¢
            document.getElementById('statsPending').textContent = '0';
            document.getElementById('statsSuccess').textContent = '0';
            document.getElementById('statsError').textContent = '0';
            folderPathDisplay.textContent = 'æœªé€‰æ‹©æ–‡ä»¶å¤¹';
            document.getElementById('progressContainer').innerHTML = '';
        }

        // é€‰æ‹©æ–‡ä»¶å¤¹é€»è¾‘
        document.getElementById('selectFolder').addEventListener('click', async () => {
            resetAllStates();  // é€‰æ‹©å‰å…ˆé‡ç½®æ—§çŠ¶æ€
            try {
                const folderRes = await fetch('/select-folder');
                const { folderPath } = await folderRes.json();

                if (!folderPath) {
                    alert('è¯·é€‰æ‹©ä¸€ä¸ªåŒ…å«å›¾ç‰‡çš„æ–‡ä»¶å¤¹');
                    return;
                }

                folderPathDisplay.textContent = folderPath;  // æ˜¾ç¤ºè·¯å¾„

                const startRes = await fetch('/start-process', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ folder: folderPath })
                });
                const { taskId: newTaskId } = await startRes.json();
                taskId = newTaskId;

                progressInterval = setInterval(pollProgress, 1500);  // å¯åŠ¨è½®è¯¢
            } catch (error) {
                console.error('æ“ä½œå¤±è´¥:', error);
                alert('é€‰æ‹©æ–‡ä»¶å¤¹æ—¶å‘ç”Ÿé”™è¯¯ï¼Œè¯·é‡è¯•');
            }
        });

        // é‡ç½®æŒ‰é’®é€»è¾‘ï¼ˆå…³é”®ä¿®æ”¹ï¼‰
        document.getElementById('resetBtn').addEventListener('click', async () => {
            if (!taskId) {
                alert('å½“å‰æ— ä»»åŠ¡å¯é‡ç½®');
                return;
            }

            try {
                // 1. å‘åç«¯å‘é€åœæ­¢ä»»åŠ¡è¯·æ±‚ï¼ˆéœ€åç«¯çœŸæ­£åœæ­¢ä»»åŠ¡ï¼‰
                const stopRes = await fetch(`/stop-process/${taskId}`, { method: 'POST' });
                const stopResult = await stopRes.json();

                if (stopResult.status !== 'success') {
                    throw new Error(stopResult.message);
                }

                // 2. åœæ­¢æˆåŠŸåï¼Œæç¤ºç”¨æˆ·å¹¶é‡ç½®å‰ç«¯
                alert('ä»»åŠ¡å·²é‡ç½®ï¼');  // æ˜¾ç¤ºæç¤º
                resetAllStates();  // ç‚¹å‡»ç¡®å®šåé‡ç½®ç•Œé¢
            } catch (error) {
                console.error('é‡ç½®å¤±è´¥:', error);
                alert(`é‡ç½®å¤±è´¥ï¼š${error.message || 'è¯·é‡è¯•'}`);
            }
        });

        // è½®è¯¢è¿›åº¦é€»è¾‘ï¼ˆæœªä¿®æ”¹ï¼‰
        function pollProgress() {
            const progressContainer = document.getElementById('progressContainer');
            if (!taskId) return;

            fetch(`/process-status/${taskId}`)
                .then(res => res.json())
                .then(({ progress, isComplete }) => {
                    const systemMsg = progress.find(item =>
                        item.filename === 'ç³»ç»Ÿæç¤º' &&
                        item.message.includes('å¾…å¤„ç†å›¾ç‰‡')
                    );
                    if (systemMsg && !totalImages) {
                        const count = parseInt(systemMsg.message.match(/\d+/)[0]);
                        totalImages = count || 0;
                        document.getElementById('statsPending').textContent = totalImages;
                    }

                    let success = 0, error = 0;
                    progress.forEach(item => {
                        if (item.filename === 'ç³»ç»Ÿæç¤º') return;
                        if (item.status === 'success') success++;
                        if (item.status === 'error') error++;
                    });

                    const pending = totalImages ?
                        Math.max(totalImages - success - error, 0) :
                        '?';

                    document.getElementById('statsPending').textContent = pending;
                    document.getElementById('statsSuccess').textContent = success;
                    document.getElementById('statsError').textContent = error;

                    progressContainer.innerHTML = progress.map(item => {
                        let className, statusText;
                        switch(item.status) {
                            case 'processing':
                                className = 'progress-processing';
                                statusText = 'å¤„ç†ä¸­';
                                break;
                            case 'success':
                                className = 'progress-success';
                                statusText = 'å·²æˆåŠŸ';
                                break;
                            case 'error':
                                className = 'progress-error';
                                statusText = 'å¤„ç†å¤±è´¥';
                                break;
                            default:
                                className = '';
                                statusText = item.status;
                        }
                        return `
                            <div class="progress-item ${className}">
                                <span>${item.filename}</span>
                                <span>${statusText}: ${item.message}</span>
                            </div>
                        `;
                    }).join('');

                    if (isComplete) clearInterval(progressInterval);
                })
                .catch(error => {
                    console.error('è¿›åº¦è·å–å¤±è´¥:', error);
                    progressContainer.innerHTML = `
                        <div class="progress-item progress-error">
                            æ— æ³•è·å–å¤„ç†è¿›åº¦ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥
                        </div>
                    `;
                });
        }
    </script>
</body>
</html>
    